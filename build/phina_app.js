phina.globalize();

var QUERY           = QueryString.parse();
var SCREEN_WIDTH    = 960;
var SCREEN_HEIGHT   = 640;
var PIECE_SIZE      = 80;
var PIECE_SIZE_HALF = PIECE_SIZE/2;
var FLOOR_HEIGHT    = 128;
var FLOOR_Y         = SCREEN_HEIGHT-FLOOR_HEIGHT;
var SPEED           = 16;
var SCORE_BOX_HEIGHT= 100;
var TILE_WIDTH = 32;

var TOUCH_SE = 'data:audio/x-m4a;base64,AAAAHGZ0eXBNNEEgAAAAAE00QSBtcDQyaXNvbQAAA2ptb292AAAAbG12aGQAAAAAth9I0bYfSNEAAKxEAAA4AAABAAABAAAAAAAAAAAAAAAAAQAAAAAAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACAAAB/HRyYWsAAABcdGtoZAAAAAG2H0jRth9I0QAAAAEAAAAAAAA4AAAAAAAAAAAAAAAAAAEAAAAAAQAAAAAAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAAAZhtZGlhAAAAIG1kaGQAAAAAth9I0bYfSNEAAKxEAAA4AAAAAAAAAAAiaGRscgAAAAAAAAAAc291bgAAAAAAAAAAAAAAAAAAAAABTm1pbmYAAAAQc21oZAAAAAAAAAAAAAAAJGRpbmYAAAAcZHJlZgAAAAAAAAABAAAADHVybCAAAAABAAABEnN0YmwAAAB2c3RzZAAAAAAAAAABAAAAZm1wNGEAAAAAAAAAAQAAAAAAAAAAAAIAEAAAAACsRAAAAAAAM2VzZHMAAAAAA4CAgCIAAAAEgICAFEAVABgAAAAAAAAA+gAFgICAAhIIBoCAgAECAAAAD3NidGQAAAAASTE2AAAAGHN0dHMAAAAAAAAAAQAAAA4AAAQAAAAAHHN0c2MAAAAAAAAAAQAAAAEAAAAOAAAAAQAAAExzdHN6AAAAAAAAAAAAAAAOAAAABAAAALYAAADwAAABAAAAASoAAADJAAAAwAAAAL8AAADIAAAAxwAAAMQAAAD0AAAAmAAAACsAAAAUc3RjbwAAAAAAAAABAAAQAAAAAPp1ZHRhAAAA8m1ldGEAAAAAAAAAImhkbHIAAAAAAAAAAG1kaXJhcHBsAAAAAAAAAAAAAAAAAMRpbHN0AAAAvC0tLS0AAAAcbWVhbgAAAABjb20uYXBwbGUuaVR1bmVzAAAAFG5hbWUAAAAAaVR1blNNUEIAAACEZGF0YQAAAAEAAAAAIDAwMDAwMDAwIDAwMDAwODQwIDAwMDAwMzlDIDAwMDAwMDAwMDAwMDJDMjQgMDAwMDAwMDAgMDAwMDAwMDAgMDAwMDAwMDAgMDAwMDAwMDAgMDAwMDAwMDAgMDAwMDAwMDAgMDAwMDAwMDAgMDAwMDAwMDAAAAxyZnJlZQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA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';

var ASSETS = {
  image: {
    'ground': '../assets/ground.png',
    'background': '../assets/background.png',
    'tube1': '../assets/tube1.png',
    'tube2': '../assets/tube2.png',
    'character': '../assets/{0}.png'.format(QUERY.c || 'tomapiyo'),
  },

  spritesheet: {
    'character': '../assets/character.tmss',
  },

  sound: {
    'touch': TOUCH_SE,
    'damage': '../assets/damage.mp3'
  },
};


phina.define('MainScene', {
  superClass: 'DisplayScene',

  init: function() {
    this.superInit({
      width: SCREEN_WIDTH,
      height: SCREEN_HEIGHT,
    });

    this.fromJSON({
      children: {
        bg: {
          className: 'Sprite',
          arguments: 'background',
          y: -FLOOR_HEIGHT,
          originX: 0,
          originY: 0,
        },
        tubeGroup: {
          className: 'DisplayElement',
        },
        scoreBoxGroup: {
          className: 'DisplayElement',
        },
        floor: {
          className: 'Floor',
          y: SCREEN_HEIGHT,
        },
        scoreLabel: {
          className: 'Label',
          text: '999',
          x: this.gridX.center(),
          y: this.gridX.span(1),
          fontSize: 32,
          fill: 'white',
          stroke: 'black',
          strokeWidth: 8,
        }
      },
    });

    this.score = 0;
    this.isStart = false;

    this.player = Player().addChildTo(this);
    this.player.setPosition(this.gridX.span(2), this.gridY.center());

    this.onpointstart = function() {
      if (!this.isStart) {
        this.player.physical.gravity.set(0, 1);
        this.isStart = true;
      }

      this.player.fly();
      SoundManager.play('touch');
    };

    this.player.onscreenout = this.hit.bind(this);
    this.player.onfall = this.gameover.bind(this);
  },

  update: function(app) {
    if (!this.isStart) {
      this.player.y = this.gridY.center();
      return ;
    }

    if (app.frame % 30 === 0) {
      this.createTube();
    }

    // スコアボックスとの衝突判定
    this.scoreBoxGroup.children.each(function(child) {
      if (this.player.hitTestElement(child)) {
        child.remove();
        this.score += 1;
      }
      else {
      }
    }, this);
    // チューブとの衝突判定
    this.tubeGroup.children.each(function(child) {
      if (this.player.hitTestElement(child)) {
        this.hit();
        this.update = null;
      }
    }, this);
  },

  hit: function() {
    this.tubeGroup.sleep();
    this.scoreBoxGroup.sleep();
    this.floor.sleep();
    this.player.fall();

    SoundManager.play('damage');
  },

  gameover: function() {

    var dialog = GameOverDialog({
      score: this.score,
    });
    this.app.pushScene(dialog);

    dialog.onexit = function() {
      this.exit('main');
    }.bind(this);
  },

  createTube: function() {
    var base = Math.randint(180, 360);
    var tube1 = Tube(1).addChildTo(this.tubeGroup);
    var tube2 = Tube(2).addChildTo(this.tubeGroup);

    tube1.left = this.gridX.width;
    tube2.left = this.gridX.width;

    tube1.originY = 1;
    tube2.originY = 0;
    tube1.y = base - SCORE_BOX_HEIGHT/2;
    tube2.y = base + SCORE_BOX_HEIGHT/2;

    // スコアボックスを生成
    var scoreBox = ScoreBox().addChildTo(this.scoreBoxGroup);
    scoreBox.left = this.gridX.width;
    scoreBox.y = base;
  },

  _accessor: {
    score: {
      get: function() { return this._score; },
      set: function(v) {
        this._score = v;
        this.scoreLabel.text = v;
      }
    }
  }
});

phina.define('Floor', {
  superClass: 'PlainElement',

  init: function() {
    this.superInit();

    this.canvas.width = SCREEN_WIDTH+64;
    this.canvas.height = FLOOR_HEIGHT;
    this.originX = 0;
    this.originY = 1;
    this.padding = 0;

    this.render();

    this.x = 0;
  },
  render: function() {
    var c = this.canvas;
    var ground = AssetManager.get('image', 'ground');
    var count = SCREEN_WIDTH/TILE_WIDTH+1;
    (count).times(function(i) {
      c.context.drawImage(ground.domElement, i*TILE_WIDTH, 0, TILE_WIDTH, FLOOR_HEIGHT);
    });
  },
  update: function() {
    this.x-=SPEED;

    if (this.x < -TILE_WIDTH) {
      this.x = 0;
    }
  }
});

phina.define('Player', {
  superClass: 'DisplayElement',

  init: function(index) {
    this.superInit({
      width: 32,
      height: 32,
    });

    this.sprite = Sprite('character').addChildTo(this);
    this.sprite.anim = FrameAnimation('character').attachTo(this.sprite);
    this.sprite.anim.gotoAndPlay('fly');

    this.lock = false;
  },

  update: function() {
    this.rotation = this.physical.velocity.y*2+5;

    if (this.bottom > FLOOR_Y) {
      this.bottom = FLOOR_Y;
      this.rotation = 0;
      this.sprite.anim.gotoAndPlay('die');
      this.flare('fall');
    }

    if (!this.lock && this.bottom < 0) {
      this.flare('screenout');
    }
  },

  fly: function() {
    if (this.lock) return ;
    this.physical.force(0, -12);
  },

  fall: function() {
    this.lock = true;
    this.physical.force(0, -5);

    this.sprite.anim.gotoAndPlay('damage');
  },
});

phina.define('Tube', {
  superClass: 'Sprite',

  init: function(type) {
    this.superInit('tube' + type);
  },
  update: function() {
    this.x-=SPEED;

    if (this.right < 0) {
      this.remove();
    }
  }
});

phina.define('ScoreBox', {
  superClass: 'DisplayElement',

  init: function() {
    this.superInit({
      width: 40,
      height: SCORE_BOX_HEIGHT,
    });
  },
  update: function() {
    this.x-=SPEED;

    if (this.right < 0) {
      this.remove();
    }
  }
});


phina.define('GameOverDialog', {
  superClass: 'DisplayScene',

  init: function(options) {
    this.superInit({
      width: SCREEN_WIDTH,
      height: SCREEN_HEIGHT,
    });

    this.backgroundColor = 'rgba(0, 0, 0, 0.2)';

    this.fromJSON({
      children: {
        frame: {
          className: 'RectangleShape',
          x: this.gridX.center(),
          y: this.gridY.center(),
          cornerRadius: 6,
          fill: 'hsl(50, 100%, 90%)',
          stroke: 'brown',
          width: 320,
          height: 220,
        },
        scoreText: {
          className: 'Label',
          fontSize: 22,
          x: this.gridX.center(),
          y: this.gridY.center(-1),
          fill: '#CFA551',
          text: 'SCORE',
        },
        scoreLabel: {
          className: 'Label',
          fontSize: 32,
          x: this.gridX.center(),
          y: this.gridY.center(1),
          fontSize: 48,
          fill: 'white',
          stroke: 'black',
          strokeWidth: 8,
          text: '4321',
        },
        btnOK: {
          className: 'Button',
          x: this.gridX.center(-1.5),
          y: this.gridY.center(4),
          width: this.gridX.span(2.5),
          height: this.gridY.span(1.5),
          fill: 'orange',
          stroke: 'brown',
          text: 'OK',
          fontSize: 26,
        },
        btnShare: {
          className: 'Button',
          x: this.gridX.center(1.5),
          y: this.gridY.center(4),
          width: this.gridX.span(2.5),
          height: this.gridY.span(1.5),
          fill: 'orange',
          stroke: 'brown',
          text: 'SHARE',
          fontSize: 26,
        },
      }
    });

    this.btnOK.onpush = function() {
      this.exit();
    }.bind(this);
    this.btnShare.onclick = function() {
      var url = Twitter.createURL({
        text: 'phina.js のマスコットキャラ素材が一通り揃ったので記念にゲーム作りました♪ SCORE: {score}'.format(options),
        hashtags: 'js,game,phina_js',
        url: location.href,
      });
      window.open(url, 'share window', 'width=480, height=320');
    }.bind(this);

    this.score = 0;
    this.tweener
      .to({score: options.score})
      ;
  },

  update: function() {
    this.scoreLabel.text = this.score|0;
  },
});


phina.main(function() {

  var app = GameApp({
    title: 'phinappy bird',
    width: SCREEN_WIDTH,
    height: SCREEN_HEIGHT,
    assets: ASSETS,
    startLabel: location.search.substr(1).toObject().scene || 'main',
    startLabel: 'main',
  });

  // app.enableStats();

  app.run();
  
});



//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIm1haW4uanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBIiwiZmlsZSI6InBoaW5hX2FwcC5qcyIsInNvdXJjZXNDb250ZW50IjpbInBoaW5hLmdsb2JhbGl6ZSgpO1xuXG52YXIgUVVFUlkgICAgICAgICAgID0gUXVlcnlTdHJpbmcucGFyc2UoKTtcbnZhciBTQ1JFRU5fV0lEVEggICAgPSA5NjA7XG52YXIgU0NSRUVOX0hFSUdIVCAgID0gNjQwO1xudmFyIFBJRUNFX1NJWkUgICAgICA9IDgwO1xudmFyIFBJRUNFX1NJWkVfSEFMRiA9IFBJRUNFX1NJWkUvMjtcbnZhciBGTE9PUl9IRUlHSFQgICAgPSAxMjg7XG52YXIgRkxPT1JfWSAgICAgICAgID0gU0NSRUVOX0hFSUdIVC1GTE9PUl9IRUlHSFQ7XG52YXIgU1BFRUQgICAgICAgICAgID0gMTY7XG52YXIgU0NPUkVfQk9YX0hFSUdIVD0gMTAwO1xudmFyIFRJTEVfV0lEVEggPSAzMjtcblxudmFyIFRPVUNIX1NFID0gJ2RhdGE6YXVkaW8veC1tNGE7YmFzZTY0LEFBQUFIR1owZVhCTk5FRWdBQUFBQUUwMFFTQnRjRFF5YVhOdmJRQUFBMnB0YjI5MkFBQUFiRzEyYUdRQUFBQUF0aDlJMGJZZlNORUFBS3hFQUFBNEFBQUJBQUFCQUFBQUFBQUFBQUFBQUFBQUFRQUFBQUFBQUFBQUFBQUFBQUFBQUFFQUFBQUFBQUFBQUFBQUFBQUFBRUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQ0FBQUIvSFJ5WVdzQUFBQmNkR3RvWkFBQUFBRzJIMGpSdGg5STBRQUFBQUVBQUFBQUFBQTRBQUFBQUFBQUFBQUFBQUFBQUFFQUFBQUFBUUFBQUFBQUFBQUFBQUFBQUFBQUFBRUFBQUFBQUFBQUFBQUFBQUFBQUVBQUFBQUFBQUFBQUFBQUFBQUFBWmh0WkdsaEFBQUFJRzFrYUdRQUFBQUF0aDlJMGJZZlNORUFBS3hFQUFBNEFBQUFBQUFBQUFBaWFHUnNjZ0FBQUFBQUFBQUFjMjkxYmdBQUFBQUFBQUFBQUFBQUFBQUFBQUFCVG0xcGJtWUFBQUFRYzIxb1pBQUFBQUFBQUFBQUFBQUFKR1JwYm1ZQUFBQWNaSEpsWmdBQUFBQUFBQUFCQUFBQURIVnliQ0FBQUFBQkFBQUJFbk4wWW13QUFBQjJjM1J6WkFBQUFBQUFBQUFCQUFBQVptMXdOR0VBQUFBQUFBQUFBUUFBQUFBQUFBQUFBQUlBRUFBQUFBQ3NSQUFBQUFBQU0yVnpaSE1BQUFBQUE0Q0FnQ0lBQUFBRWdJQ0FGRUFWQUJnQUFBQUFBQUFBK2dBRmdJQ0FBaElJQm9DQWdBRUNBQUFBRDNOaWRHUUFBQUFBU1RFMkFBQUFHSE4wZEhNQUFBQUFBQUFBQVFBQUFBNEFBQVFBQUFBQUhITjBjMk1BQUFBQUFBQUFBUUFBQUFFQUFBQU9BQUFBQVFBQUFFeHpkSE42QUFBQUFBQUFBQUFBQUFBT0FBQUFCQUFBQUxZQUFBRHdBQUFCQUFBQUFTb0FBQURKQUFBQXdBQUFBTDhBQUFESUFBQUF4d0FBQU1RQUFBRDBBQUFBbUFBQUFDc0FBQUFVYzNSamJ3QUFBQUFBQUFBQkFBQVFBQUFBQVBwMVpIUmhBQUFBOG0xbGRHRUFBQUFBQUFBQUltaGtiSElBQUFBQUFBQUFBRzFrYVhKaGNIQnNBQUFBQUFBQUFBQUFBQUFBQU1ScGJITjBBQUFBdkMwdExTMEFBQUFjYldWaGJnQUFBQUJqYjIwdVlYQndiR1V1YVZSMWJtVnpBQUFBRkc1aGJXVUFBQUFBYVZSMWJsTk5VRUlBQUFDRVpHRjBZUUFBQUFFQUFBQUFJREF3TURBd01EQXdJREF3TURBd09EUXdJREF3TURBd016bERJREF3TURBd01EQXdNREF3TURKRE1qUWdNREF3TURBd01EQWdNREF3TURBd01EQWdNREF3TURBd01EQWdNREF3TURBd01EQWdNREF3TURBd01EQWdNREF3TURBd01EQWdNREF3TURBd01EQWdNREF3TURBd01EQUFBQXh5Wm5KbFpRQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQW91YldSaGRBRFFRQWNCQXBuSVBidGNVbE1KTVJpcHc5LzdYL00weTJ2NmVmL3JuKzkvcjg5RDExL2I5UDMrUHdCRHF3TjVlRlNWaUVLV1RRMGhFbWJqeXBBSVRVY2JrQUI3ZjdCOS94ekYvNE1QeWdMKzVVNjRiak03U0J6a204TTFISDJTR0lSbkE1eDdQMnV1SjVCQ0tMeGdzc0ZjTHFMWjNGZXZQUnIwRjNDTVQ4aElwS3YxL2lDbzg0QUhOMDRsSWp3ZDlrZnBncHZyUkdTckp4NjZwQjBVbWNweVM1eklnWi8yRjdtV25CYUg4UjBYV1VYR290TGE4a0QzNEFFeW1UN2NOQ1Z1SXhzSm1UWkluOC94L3gxK3ZUb2U3OXRlUGI2ZGF4L1Q1LzAvZXR6UGdCc2wwalRjSm5vZzNCa01OQ0tUYnIrNXIwcDRiYy9zRGVPWSs3cXl4MFgzK2dDcCt4RDRsVDJSUWNVVzZQSGpkYjlkS3FGZzFpaGlOMHFKMHprUm1kS3lsYVVXaW5OQXNHTEN0Z256Vm56RmZDYWdHa0RDWlZCMmFiUFBjT3NYTVZBeUl4QUhtd256KzJPTmJtYnhMVVJtamZSSmx4S2JjSVBRVUxOTlJyc0REckVpRW1BS1ZURjM0eENOYS9TVjJtRzRqQUNpV1FvSVJOM2tRU2g0UWpYYkk2c3BYQW9JUzV2K0YyTk5vN2VBc3dIZW5samN2bnJpVjlveTdwL3dkSlRnQXVtOTJzTGZnQUVlbVg3YlFVVHRJclVFMnFmMC9ucUgyZEdmMjE1K09MK1pYd1FIVzhxVDNPTzh1U0sxVmJ6VjFkd0U0Ni9UbU5XODJEeDRIcGxhN1ZYOTY2M055MHFpOXJFQ0Z5VFhSTGcwQ3p5OGYycUVKcGRIV3QxQzBEclRqU3VVODY4N2VHK3BiUi9NdHdKNy9mUUpOSTY4SS9SblFjaFRzS05EZlZYZXBCczY4MTJWbVlvczhLSUtkR0tMcHJUSlo0RERSaGhWQmVZaktiUmE4NmlRbGswQUlOblhaRmR4a3FJa2l5Q3pPQUdGd29CdVVML0hzcW41cGIyYzUwWVR5V3NVNld2eTVaYzl5TmZ4M1RNWlZKZ01LZThUdGJManVuVWRqcXU0cXhXSzRGN3RWZEZaMzkyczkrcTNNY1RNczNzdmhxV3p2dTV4a2pLdDZNYzkvMjhldzRBQklKa3kyeW1FN3JSSGFoSnplVFdvcVYveC9qVCtudDlEV3YvSCtWZlBmdDFuMGY5Sy9tZWF5d3orbnR4MG9HLzZWL24ybmNDZGJaQUJIV3VRZkR6azFMNFp6NzV0MTdvcHBPTTRRaldNM0djSGpsZWY5T2IrbDRZKy9jRGp6QmhvN2F6TWN3blVVNHhBK0hsSGU3ZzNpRWpma0FyQXRvazFsUVlDY3RQaVgxSDRyajNoMjQ4TDQ4a3JWbVFNNXVoTzQ5b3JvZ3dMdGVnUys2VUtlT3FBSHg2eHlzRjdsa0wxOTJqTzBCcnk3NWkzbFF2bUUrQ1N1aW1QL3J6YmMxUjdvY3d2d3hvYnVkTG8vVjJubXJ0UTdhZVBoQ2Fxa3hIM0J4clpRN0FZSlFUb25DOFJMdks3eTZHdnZFZjFkQ0RZL3FlUzJobThyREdtL04vRXd3dG9mVmFCZUpGYTFkaThUOHV1Ykd5Z0xjeHRzWlNXVElUaTFVTkMzQklVOVhhdmVFNUFSckNFM2kvQUFTalZyVXpFS1l5U0pFSzdiZlBmT0M4WE5XbkYzNUJJeUN3Um9IOWhvRVA4L1ZucmZ3RnZoK1E1YnZyUHZhM2d2TzNlbVB4a0R6K3JOVi84cm03Y2ExNjd1R09NT1BYNXYzOE1abWJkdDB3SkE0WVY5dmRJZU0vYXZodTZjZTN3d3BjN1RJeU1nYnZXWndWekZjUVBiQUdCL3c4L1lBQUFBQUtqRHc5MmcxV2RQa2JQSnRuMEgyckxsdElLSUd3eityd3d2bnhPeFFFN0ErSUdCRDlxaWJ3NHlUeEl4RTZWamx4WDg5dEtkVm1wL3R2ZUlMREJPcWJFV01JaU5MS0taWUsxcng2TE1zUU9BU0FWckV4ckdZbU9vMElJU1NKamJ1ZXQxNEpyMWVsczZOdUh4b0lDbkFxU0hmME1GeXUxOGFhSHlkSFp5NUU3ZS81ZTM5b2ZaTlVmcTRKNFZmdmtzS01RbHZreDBNWU1iTlRNREZnS0VOT01ZeEl4aVJqdjM5WDNXeWlTa3VXN1VkR3FDbW9RVUZCUVVGLzR2L0YrS21vZ3J3Z1pnN2lNbVRNMDd6ZXBscXhQaXJwZmRzRE9DWVJEejVkblVnWXE3YkplMEM2WnpDQll6THhsRDc5cVEvNUdlV3RJcWxXTlZKNElMem5HUEg5bGVVdWNXY2tuUkxjOGthcFl2VUJ3QVJRVnJDeWJJeFVPVGhHOEtqdDM4NXZ6bkxoYWRMdUxBUXBtb01BeTdodW03dnZxaTJPMmlvdE9Va3o5Y0p3bHZlcTg0OEQ3SWZ2OS9INFB2LzFQUjhQYmxNVnpxQ083eURUTmJiTWVtTXM0SkhtRXBDMWRpb1d0SHBQZ0JGN3F6bFNZc1B1cEs1RnVpa0lsdlBmZ1NRcEo1VHdIbVcxMUtMMlJaVTJ6OXBqbTIvYkd3dEVvL05RZTVSUTFCWSthK3RpZlQrMTByU1RGSFc2ZzRPcEZSdW1SWm9UbGF6ZlRLWWRoYVFrRXdKc2pCOU5veERBQWNYVzZtUFBLNEhBQkdCV3NOUUlNRUpncGVKWER0Nlo3OXRIZnQwMHZWZ1JTQWdzVzFTVXRQVW9XczdIcXpTYzZ4di9EOHcvb0xFNnNPV1R0LzVDT1Q0VG8yU2dTbXRGSFpLajRYWW1hbGtDUEJiUldIYUpmR2VVbmVuTXRXdHR4YnZZVk92c0psTjlBaE1zQkF6cXhVdXhscDB0ZHVUNGhkaGw0VWR6c1dhMHpyUXlRWWdXM2owOWEwSHNkY094T2drV216dzIyajBkUDhVcUJtekp4bGN6RzRxYURsaWxrbGFlU041UElTdlR3d1M1L1pITERzbkRKMnhUek9yOU9uaUdLT0NIa2lXdzF5eXNxNzN0RURnRWVGYWtXVWd3TmlJSVFvSWlvRWlpWklwMzJkbXJZMGswNmxDMklVQmNwZHI4dXl5bTBDK3RtMHV1d3BxekxxNnBtVGQ2TVNJMlgzLzJNMFdRK0g4d3FDZEtwSHpwNnh6VW1oaHVkelpkMVhNaXhPYUVMRlRhdEVqWWE5bmtzOExaTk5EUlVJbzlaYmdESUZwWGFEMHV6c0xhc3RJOTRFcXN5TTVnL1d5eDV1Vld3K044NnlrKzg3YkZsRXFLbTRNVFFhejJ6dlZTek0xWkVwcEFiTlNxYjQvS2doSzFpOFMyTlAxTENkV0MrSmlJUmZhN1Q1STdDMXJWbHVoaDBKeUNXNmVuZ0FjQUJBaFdzTUpzaUVZcERNSkZRZ25aSWZMdjh0M09yWDlMTmtGQXFHK2dsUzllZ1pIclk1ZDV2ZTYrNGZVak12MWg4bndtVGc5dDNhVHMvWG5GbUtTQTM0dXBQQ2NRMDR1bkRBR0R0QmtmRHBHZWNNS0s0eUV6M004VEtCd3dCVEphTmRzSm9rT0xxb1ljam5QNEQ2N1NxMUoxWms2M09jSzdPcmFsVDJqbXRvTDZqNFBiU3ozTitOdzdpTHdxMHhnRnFheEIybVdSY0VFVXgyZDFpVmlLamRnZXJhK1ExdVN5U09nczNFbjNsd1VUUW5GV1duSEtsY05nRDJldDNtdGIxN0FPQUFRUVZyckFrRVR4R2JrUHR6dDRQWnE5ZVoyNTBBSWhSWW9telZNZVIzRDNOaStpOWhvM3JjSDVEK2hHRUVPVGU0MEJ4em0zdGh2Vk9wYzAvQStpMHQyVjBqakx6Nm9Ka0hnaE95Y3ZiY1kwUzdueit4NFpBdFU1bTRmekI5LzdVeXVIMGFWQkV3QXpVUUNHaURaM1lUV1dndzVNSVFPc2cxaEJ5aUIwa0Nnd0FQeUhhYkRJNHJnRVRBc3hVdDArV011RjJWc3ZxUkpLbkJzNlgrYmRKbGE1L2FlOUd6MWdWT3ZXL0MzbVBBbCtGS0oraHR6OE01UXk4NWdsRXpyWkxiQ0pZTzlkZ1VzNzVLUUE2TjdyM01rUlFnSUVFamhzazdUVU0vUGFoaWsrM3ZiV0tKaHVlT05oMm1BMjNZMDJ6NlNXaUJ3RUtGYW1FT0JNVVhBWVFxZWQ1OWxjdHROSjFuRjNyb3N5ZzlMbFZJaUdRLzRDOXBqQnpMVlNTQUtta3JFTVVpVGdmbGZidkhJTGEyV2RqUkxOOFozSFhIenFQS3F1NnBrVUd5R2hvN1c5b3NqNFlkdUR1N3U3dTd1LzhCalJOZU5rL2hndGtwK21MRVJHT3RmaFB5VTJVN1JoMS90OUxmdCtHOWdOZU5UZmhhOVlTU0RYcnk3STAxUXRObFRSd2lHcnJyeXo4a1FPQUFRSVZoSlNBK0I1MDBNU2x5cmhZVkR3QUI4MTVyT1ZMYVJvc0RiTFBHVStpcHJEWnE3VW9OZ3JXY0E9PSc7XG5cbnZhciBBU1NFVFMgPSB7XG4gIGltYWdlOiB7XG4gICAgJ2dyb3VuZCc6ICcuLi9hc3NldHMvZ3JvdW5kLnBuZycsXG4gICAgJ2JhY2tncm91bmQnOiAnLi4vYXNzZXRzL2JhY2tncm91bmQucG5nJyxcbiAgICAndHViZTEnOiAnLi4vYXNzZXRzL3R1YmUxLnBuZycsXG4gICAgJ3R1YmUyJzogJy4uL2Fzc2V0cy90dWJlMi5wbmcnLFxuICAgICdjaGFyYWN0ZXInOiAnLi4vYXNzZXRzL3swfS5wbmcnLmZvcm1hdChRVUVSWS5jIHx8ICd0b21hcGl5bycpLFxuICB9LFxuXG4gIHNwcml0ZXNoZWV0OiB7XG4gICAgJ2NoYXJhY3Rlcic6ICcuLi9hc3NldHMvY2hhcmFjdGVyLnRtc3MnLFxuICB9LFxuXG4gIHNvdW5kOiB7XG4gICAgJ3RvdWNoJzogVE9VQ0hfU0UsXG4gICAgJ2RhbWFnZSc6ICcuLi9hc3NldHMvZGFtYWdlLm1wMydcbiAgfSxcbn07XG5cblxucGhpbmEuZGVmaW5lKCdNYWluU2NlbmUnLCB7XG4gIHN1cGVyQ2xhc3M6ICdEaXNwbGF5U2NlbmUnLFxuXG4gIGluaXQ6IGZ1bmN0aW9uKCkge1xuICAgIHRoaXMuc3VwZXJJbml0KHtcbiAgICAgIHdpZHRoOiBTQ1JFRU5fV0lEVEgsXG4gICAgICBoZWlnaHQ6IFNDUkVFTl9IRUlHSFQsXG4gICAgfSk7XG5cbiAgICB0aGlzLmZyb21KU09OKHtcbiAgICAgIGNoaWxkcmVuOiB7XG4gICAgICAgIGJnOiB7XG4gICAgICAgICAgY2xhc3NOYW1lOiAnU3ByaXRlJyxcbiAgICAgICAgICBhcmd1bWVudHM6ICdiYWNrZ3JvdW5kJyxcbiAgICAgICAgICB5OiAtRkxPT1JfSEVJR0hULFxuICAgICAgICAgIG9yaWdpblg6IDAsXG4gICAgICAgICAgb3JpZ2luWTogMCxcbiAgICAgICAgfSxcbiAgICAgICAgdHViZUdyb3VwOiB7XG4gICAgICAgICAgY2xhc3NOYW1lOiAnRGlzcGxheUVsZW1lbnQnLFxuICAgICAgICB9LFxuICAgICAgICBzY29yZUJveEdyb3VwOiB7XG4gICAgICAgICAgY2xhc3NOYW1lOiAnRGlzcGxheUVsZW1lbnQnLFxuICAgICAgICB9LFxuICAgICAgICBmbG9vcjoge1xuICAgICAgICAgIGNsYXNzTmFtZTogJ0Zsb29yJyxcbiAgICAgICAgICB5OiBTQ1JFRU5fSEVJR0hULFxuICAgICAgICB9LFxuICAgICAgICBzY29yZUxhYmVsOiB7XG4gICAgICAgICAgY2xhc3NOYW1lOiAnTGFiZWwnLFxuICAgICAgICAgIHRleHQ6ICc5OTknLFxuICAgICAgICAgIHg6IHRoaXMuZ3JpZFguY2VudGVyKCksXG4gICAgICAgICAgeTogdGhpcy5ncmlkWC5zcGFuKDEpLFxuICAgICAgICAgIGZvbnRTaXplOiAzMixcbiAgICAgICAgICBmaWxsOiAnd2hpdGUnLFxuICAgICAgICAgIHN0cm9rZTogJ2JsYWNrJyxcbiAgICAgICAgICBzdHJva2VXaWR0aDogOCxcbiAgICAgICAgfVxuICAgICAgfSxcbiAgICB9KTtcblxuICAgIHRoaXMuc2NvcmUgPSAwO1xuICAgIHRoaXMuaXNTdGFydCA9IGZhbHNlO1xuXG4gICAgdGhpcy5wbGF5ZXIgPSBQbGF5ZXIoKS5hZGRDaGlsZFRvKHRoaXMpO1xuICAgIHRoaXMucGxheWVyLnNldFBvc2l0aW9uKHRoaXMuZ3JpZFguc3BhbigyKSwgdGhpcy5ncmlkWS5jZW50ZXIoKSk7XG5cbiAgICB0aGlzLm9ucG9pbnRzdGFydCA9IGZ1bmN0aW9uKCkge1xuICAgICAgaWYgKCF0aGlzLmlzU3RhcnQpIHtcbiAgICAgICAgdGhpcy5wbGF5ZXIucGh5c2ljYWwuZ3Jhdml0eS5zZXQoMCwgMSk7XG4gICAgICAgIHRoaXMuaXNTdGFydCA9IHRydWU7XG4gICAgICB9XG5cbiAgICAgIHRoaXMucGxheWVyLmZseSgpO1xuICAgICAgU291bmRNYW5hZ2VyLnBsYXkoJ3RvdWNoJyk7XG4gICAgfTtcblxuICAgIHRoaXMucGxheWVyLm9uc2NyZWVub3V0ID0gdGhpcy5oaXQuYmluZCh0aGlzKTtcbiAgICB0aGlzLnBsYXllci5vbmZhbGwgPSB0aGlzLmdhbWVvdmVyLmJpbmQodGhpcyk7XG4gIH0sXG5cbiAgdXBkYXRlOiBmdW5jdGlvbihhcHApIHtcbiAgICBpZiAoIXRoaXMuaXNTdGFydCkge1xuICAgICAgdGhpcy5wbGF5ZXIueSA9IHRoaXMuZ3JpZFkuY2VudGVyKCk7XG4gICAgICByZXR1cm4gO1xuICAgIH1cblxuICAgIGlmIChhcHAuZnJhbWUgJSAzMCA9PT0gMCkge1xuICAgICAgdGhpcy5jcmVhdGVUdWJlKCk7XG4gICAgfVxuXG4gICAgLy8g44K544Kz44Ki44Oc44OD44Kv44K544Go44Gu6KGd56qB5Yik5a6aXG4gICAgdGhpcy5zY29yZUJveEdyb3VwLmNoaWxkcmVuLmVhY2goZnVuY3Rpb24oY2hpbGQpIHtcbiAgICAgIGlmICh0aGlzLnBsYXllci5oaXRUZXN0RWxlbWVudChjaGlsZCkpIHtcbiAgICAgICAgY2hpbGQucmVtb3ZlKCk7XG4gICAgICAgIHRoaXMuc2NvcmUgKz0gMTtcbiAgICAgIH1cbiAgICAgIGVsc2Uge1xuICAgICAgfVxuICAgIH0sIHRoaXMpO1xuICAgIC8vIOODgeODpeODvOODluOBqOOBruihneeqgeWIpOWumlxuICAgIHRoaXMudHViZUdyb3VwLmNoaWxkcmVuLmVhY2goZnVuY3Rpb24oY2hpbGQpIHtcbiAgICAgIGlmICh0aGlzLnBsYXllci5oaXRUZXN0RWxlbWVudChjaGlsZCkpIHtcbiAgICAgICAgdGhpcy5oaXQoKTtcbiAgICAgICAgdGhpcy51cGRhdGUgPSBudWxsO1xuICAgICAgfVxuICAgIH0sIHRoaXMpO1xuICB9LFxuXG4gIGhpdDogZnVuY3Rpb24oKSB7XG4gICAgdGhpcy50dWJlR3JvdXAuc2xlZXAoKTtcbiAgICB0aGlzLnNjb3JlQm94R3JvdXAuc2xlZXAoKTtcbiAgICB0aGlzLmZsb29yLnNsZWVwKCk7XG4gICAgdGhpcy5wbGF5ZXIuZmFsbCgpO1xuXG4gICAgU291bmRNYW5hZ2VyLnBsYXkoJ2RhbWFnZScpO1xuICB9LFxuXG4gIGdhbWVvdmVyOiBmdW5jdGlvbigpIHtcblxuICAgIHZhciBkaWFsb2cgPSBHYW1lT3ZlckRpYWxvZyh7XG4gICAgICBzY29yZTogdGhpcy5zY29yZSxcbiAgICB9KTtcbiAgICB0aGlzLmFwcC5wdXNoU2NlbmUoZGlhbG9nKTtcblxuICAgIGRpYWxvZy5vbmV4aXQgPSBmdW5jdGlvbigpIHtcbiAgICAgIHRoaXMuZXhpdCgnbWFpbicpO1xuICAgIH0uYmluZCh0aGlzKTtcbiAgfSxcblxuICBjcmVhdGVUdWJlOiBmdW5jdGlvbigpIHtcbiAgICB2YXIgYmFzZSA9IE1hdGgucmFuZGludCgxODAsIDM2MCk7XG4gICAgdmFyIHR1YmUxID0gVHViZSgxKS5hZGRDaGlsZFRvKHRoaXMudHViZUdyb3VwKTtcbiAgICB2YXIgdHViZTIgPSBUdWJlKDIpLmFkZENoaWxkVG8odGhpcy50dWJlR3JvdXApO1xuXG4gICAgdHViZTEubGVmdCA9IHRoaXMuZ3JpZFgud2lkdGg7XG4gICAgdHViZTIubGVmdCA9IHRoaXMuZ3JpZFgud2lkdGg7XG5cbiAgICB0dWJlMS5vcmlnaW5ZID0gMTtcbiAgICB0dWJlMi5vcmlnaW5ZID0gMDtcbiAgICB0dWJlMS55ID0gYmFzZSAtIFNDT1JFX0JPWF9IRUlHSFQvMjtcbiAgICB0dWJlMi55ID0gYmFzZSArIFNDT1JFX0JPWF9IRUlHSFQvMjtcblxuICAgIC8vIOOCueOCs+OCouODnOODg+OCr+OCueOCkueUn+aIkFxuICAgIHZhciBzY29yZUJveCA9IFNjb3JlQm94KCkuYWRkQ2hpbGRUbyh0aGlzLnNjb3JlQm94R3JvdXApO1xuICAgIHNjb3JlQm94LmxlZnQgPSB0aGlzLmdyaWRYLndpZHRoO1xuICAgIHNjb3JlQm94LnkgPSBiYXNlO1xuICB9LFxuXG4gIF9hY2Nlc3Nvcjoge1xuICAgIHNjb3JlOiB7XG4gICAgICBnZXQ6IGZ1bmN0aW9uKCkgeyByZXR1cm4gdGhpcy5fc2NvcmU7IH0sXG4gICAgICBzZXQ6IGZ1bmN0aW9uKHYpIHtcbiAgICAgICAgdGhpcy5fc2NvcmUgPSB2O1xuICAgICAgICB0aGlzLnNjb3JlTGFiZWwudGV4dCA9IHY7XG4gICAgICB9XG4gICAgfVxuICB9XG59KTtcblxucGhpbmEuZGVmaW5lKCdGbG9vcicsIHtcbiAgc3VwZXJDbGFzczogJ1BsYWluRWxlbWVudCcsXG5cbiAgaW5pdDogZnVuY3Rpb24oKSB7XG4gICAgdGhpcy5zdXBlckluaXQoKTtcblxuICAgIHRoaXMuY2FudmFzLndpZHRoID0gU0NSRUVOX1dJRFRIKzY0O1xuICAgIHRoaXMuY2FudmFzLmhlaWdodCA9IEZMT09SX0hFSUdIVDtcbiAgICB0aGlzLm9yaWdpblggPSAwO1xuICAgIHRoaXMub3JpZ2luWSA9IDE7XG4gICAgdGhpcy5wYWRkaW5nID0gMDtcblxuICAgIHRoaXMucmVuZGVyKCk7XG5cbiAgICB0aGlzLnggPSAwO1xuICB9LFxuICByZW5kZXI6IGZ1bmN0aW9uKCkge1xuICAgIHZhciBjID0gdGhpcy5jYW52YXM7XG4gICAgdmFyIGdyb3VuZCA9IEFzc2V0TWFuYWdlci5nZXQoJ2ltYWdlJywgJ2dyb3VuZCcpO1xuICAgIHZhciBjb3VudCA9IFNDUkVFTl9XSURUSC9USUxFX1dJRFRIKzE7XG4gICAgKGNvdW50KS50aW1lcyhmdW5jdGlvbihpKSB7XG4gICAgICBjLmNvbnRleHQuZHJhd0ltYWdlKGdyb3VuZC5kb21FbGVtZW50LCBpKlRJTEVfV0lEVEgsIDAsIFRJTEVfV0lEVEgsIEZMT09SX0hFSUdIVCk7XG4gICAgfSk7XG4gIH0sXG4gIHVwZGF0ZTogZnVuY3Rpb24oKSB7XG4gICAgdGhpcy54LT1TUEVFRDtcblxuICAgIGlmICh0aGlzLnggPCAtVElMRV9XSURUSCkge1xuICAgICAgdGhpcy54ID0gMDtcbiAgICB9XG4gIH1cbn0pO1xuXG5waGluYS5kZWZpbmUoJ1BsYXllcicsIHtcbiAgc3VwZXJDbGFzczogJ0Rpc3BsYXlFbGVtZW50JyxcblxuICBpbml0OiBmdW5jdGlvbihpbmRleCkge1xuICAgIHRoaXMuc3VwZXJJbml0KHtcbiAgICAgIHdpZHRoOiAzMixcbiAgICAgIGhlaWdodDogMzIsXG4gICAgfSk7XG5cbiAgICB0aGlzLnNwcml0ZSA9IFNwcml0ZSgnY2hhcmFjdGVyJykuYWRkQ2hpbGRUbyh0aGlzKTtcbiAgICB0aGlzLnNwcml0ZS5hbmltID0gRnJhbWVBbmltYXRpb24oJ2NoYXJhY3RlcicpLmF0dGFjaFRvKHRoaXMuc3ByaXRlKTtcbiAgICB0aGlzLnNwcml0ZS5hbmltLmdvdG9BbmRQbGF5KCdmbHknKTtcblxuICAgIHRoaXMubG9jayA9IGZhbHNlO1xuICB9LFxuXG4gIHVwZGF0ZTogZnVuY3Rpb24oKSB7XG4gICAgdGhpcy5yb3RhdGlvbiA9IHRoaXMucGh5c2ljYWwudmVsb2NpdHkueSoyKzU7XG5cbiAgICBpZiAodGhpcy5ib3R0b20gPiBGTE9PUl9ZKSB7XG4gICAgICB0aGlzLmJvdHRvbSA9IEZMT09SX1k7XG4gICAgICB0aGlzLnJvdGF0aW9uID0gMDtcbiAgICAgIHRoaXMuc3ByaXRlLmFuaW0uZ290b0FuZFBsYXkoJ2RpZScpO1xuICAgICAgdGhpcy5mbGFyZSgnZmFsbCcpO1xuICAgIH1cblxuICAgIGlmICghdGhpcy5sb2NrICYmIHRoaXMuYm90dG9tIDwgMCkge1xuICAgICAgdGhpcy5mbGFyZSgnc2NyZWVub3V0Jyk7XG4gICAgfVxuICB9LFxuXG4gIGZseTogZnVuY3Rpb24oKSB7XG4gICAgaWYgKHRoaXMubG9jaykgcmV0dXJuIDtcbiAgICB0aGlzLnBoeXNpY2FsLmZvcmNlKDAsIC0xMik7XG4gIH0sXG5cbiAgZmFsbDogZnVuY3Rpb24oKSB7XG4gICAgdGhpcy5sb2NrID0gdHJ1ZTtcbiAgICB0aGlzLnBoeXNpY2FsLmZvcmNlKDAsIC01KTtcblxuICAgIHRoaXMuc3ByaXRlLmFuaW0uZ290b0FuZFBsYXkoJ2RhbWFnZScpO1xuICB9LFxufSk7XG5cbnBoaW5hLmRlZmluZSgnVHViZScsIHtcbiAgc3VwZXJDbGFzczogJ1Nwcml0ZScsXG5cbiAgaW5pdDogZnVuY3Rpb24odHlwZSkge1xuICAgIHRoaXMuc3VwZXJJbml0KCd0dWJlJyArIHR5cGUpO1xuICB9LFxuICB1cGRhdGU6IGZ1bmN0aW9uKCkge1xuICAgIHRoaXMueC09U1BFRUQ7XG5cbiAgICBpZiAodGhpcy5yaWdodCA8IDApIHtcbiAgICAgIHRoaXMucmVtb3ZlKCk7XG4gICAgfVxuICB9XG59KTtcblxucGhpbmEuZGVmaW5lKCdTY29yZUJveCcsIHtcbiAgc3VwZXJDbGFzczogJ0Rpc3BsYXlFbGVtZW50JyxcblxuICBpbml0OiBmdW5jdGlvbigpIHtcbiAgICB0aGlzLnN1cGVySW5pdCh7XG4gICAgICB3aWR0aDogNDAsXG4gICAgICBoZWlnaHQ6IFNDT1JFX0JPWF9IRUlHSFQsXG4gICAgfSk7XG4gIH0sXG4gIHVwZGF0ZTogZnVuY3Rpb24oKSB7XG4gICAgdGhpcy54LT1TUEVFRDtcblxuICAgIGlmICh0aGlzLnJpZ2h0IDwgMCkge1xuICAgICAgdGhpcy5yZW1vdmUoKTtcbiAgICB9XG4gIH1cbn0pO1xuXG5cbnBoaW5hLmRlZmluZSgnR2FtZU92ZXJEaWFsb2cnLCB7XG4gIHN1cGVyQ2xhc3M6ICdEaXNwbGF5U2NlbmUnLFxuXG4gIGluaXQ6IGZ1bmN0aW9uKG9wdGlvbnMpIHtcbiAgICB0aGlzLnN1cGVySW5pdCh7XG4gICAgICB3aWR0aDogU0NSRUVOX1dJRFRILFxuICAgICAgaGVpZ2h0OiBTQ1JFRU5fSEVJR0hULFxuICAgIH0pO1xuXG4gICAgdGhpcy5iYWNrZ3JvdW5kQ29sb3IgPSAncmdiYSgwLCAwLCAwLCAwLjIpJztcblxuICAgIHRoaXMuZnJvbUpTT04oe1xuICAgICAgY2hpbGRyZW46IHtcbiAgICAgICAgZnJhbWU6IHtcbiAgICAgICAgICBjbGFzc05hbWU6ICdSZWN0YW5nbGVTaGFwZScsXG4gICAgICAgICAgeDogdGhpcy5ncmlkWC5jZW50ZXIoKSxcbiAgICAgICAgICB5OiB0aGlzLmdyaWRZLmNlbnRlcigpLFxuICAgICAgICAgIGNvcm5lclJhZGl1czogNixcbiAgICAgICAgICBmaWxsOiAnaHNsKDUwLCAxMDAlLCA5MCUpJyxcbiAgICAgICAgICBzdHJva2U6ICdicm93bicsXG4gICAgICAgICAgd2lkdGg6IDMyMCxcbiAgICAgICAgICBoZWlnaHQ6IDIyMCxcbiAgICAgICAgfSxcbiAgICAgICAgc2NvcmVUZXh0OiB7XG4gICAgICAgICAgY2xhc3NOYW1lOiAnTGFiZWwnLFxuICAgICAgICAgIGZvbnRTaXplOiAyMixcbiAgICAgICAgICB4OiB0aGlzLmdyaWRYLmNlbnRlcigpLFxuICAgICAgICAgIHk6IHRoaXMuZ3JpZFkuY2VudGVyKC0xKSxcbiAgICAgICAgICBmaWxsOiAnI0NGQTU1MScsXG4gICAgICAgICAgdGV4dDogJ1NDT1JFJyxcbiAgICAgICAgfSxcbiAgICAgICAgc2NvcmVMYWJlbDoge1xuICAgICAgICAgIGNsYXNzTmFtZTogJ0xhYmVsJyxcbiAgICAgICAgICBmb250U2l6ZTogMzIsXG4gICAgICAgICAgeDogdGhpcy5ncmlkWC5jZW50ZXIoKSxcbiAgICAgICAgICB5OiB0aGlzLmdyaWRZLmNlbnRlcigxKSxcbiAgICAgICAgICBmb250U2l6ZTogNDgsXG4gICAgICAgICAgZmlsbDogJ3doaXRlJyxcbiAgICAgICAgICBzdHJva2U6ICdibGFjaycsXG4gICAgICAgICAgc3Ryb2tlV2lkdGg6IDgsXG4gICAgICAgICAgdGV4dDogJzQzMjEnLFxuICAgICAgICB9LFxuICAgICAgICBidG5PSzoge1xuICAgICAgICAgIGNsYXNzTmFtZTogJ0J1dHRvbicsXG4gICAgICAgICAgeDogdGhpcy5ncmlkWC5jZW50ZXIoLTEuNSksXG4gICAgICAgICAgeTogdGhpcy5ncmlkWS5jZW50ZXIoNCksXG4gICAgICAgICAgd2lkdGg6IHRoaXMuZ3JpZFguc3BhbigyLjUpLFxuICAgICAgICAgIGhlaWdodDogdGhpcy5ncmlkWS5zcGFuKDEuNSksXG4gICAgICAgICAgZmlsbDogJ29yYW5nZScsXG4gICAgICAgICAgc3Ryb2tlOiAnYnJvd24nLFxuICAgICAgICAgIHRleHQ6ICdPSycsXG4gICAgICAgICAgZm9udFNpemU6IDI2LFxuICAgICAgICB9LFxuICAgICAgICBidG5TaGFyZToge1xuICAgICAgICAgIGNsYXNzTmFtZTogJ0J1dHRvbicsXG4gICAgICAgICAgeDogdGhpcy5ncmlkWC5jZW50ZXIoMS41KSxcbiAgICAgICAgICB5OiB0aGlzLmdyaWRZLmNlbnRlcig0KSxcbiAgICAgICAgICB3aWR0aDogdGhpcy5ncmlkWC5zcGFuKDIuNSksXG4gICAgICAgICAgaGVpZ2h0OiB0aGlzLmdyaWRZLnNwYW4oMS41KSxcbiAgICAgICAgICBmaWxsOiAnb3JhbmdlJyxcbiAgICAgICAgICBzdHJva2U6ICdicm93bicsXG4gICAgICAgICAgdGV4dDogJ1NIQVJFJyxcbiAgICAgICAgICBmb250U2l6ZTogMjYsXG4gICAgICAgIH0sXG4gICAgICB9XG4gICAgfSk7XG5cbiAgICB0aGlzLmJ0bk9LLm9ucHVzaCA9IGZ1bmN0aW9uKCkge1xuICAgICAgdGhpcy5leGl0KCk7XG4gICAgfS5iaW5kKHRoaXMpO1xuICAgIHRoaXMuYnRuU2hhcmUub25jbGljayA9IGZ1bmN0aW9uKCkge1xuICAgICAgdmFyIHVybCA9IFR3aXR0ZXIuY3JlYXRlVVJMKHtcbiAgICAgICAgdGV4dDogJ3BoaW5hLmpzIOOBruODnuOCueOCs+ODg+ODiOOCreODo+ODqee0oOadkOOBjOS4gOmAmuOCiuaPg+OBo+OBn+OBruOBp+iomOW/teOBq+OCsuODvOODoOS9nOOCiuOBvuOBl+OBn+KZqiBTQ09SRToge3Njb3JlfScuZm9ybWF0KG9wdGlvbnMpLFxuICAgICAgICBoYXNodGFnczogJ2pzLGdhbWUscGhpbmFfanMnLFxuICAgICAgICB1cmw6IGxvY2F0aW9uLmhyZWYsXG4gICAgICB9KTtcbiAgICAgIHdpbmRvdy5vcGVuKHVybCwgJ3NoYXJlIHdpbmRvdycsICd3aWR0aD00ODAsIGhlaWdodD0zMjAnKTtcbiAgICB9LmJpbmQodGhpcyk7XG5cbiAgICB0aGlzLnNjb3JlID0gMDtcbiAgICB0aGlzLnR3ZWVuZXJcbiAgICAgIC50byh7c2NvcmU6IG9wdGlvbnMuc2NvcmV9KVxuICAgICAgO1xuICB9LFxuXG4gIHVwZGF0ZTogZnVuY3Rpb24oKSB7XG4gICAgdGhpcy5zY29yZUxhYmVsLnRleHQgPSB0aGlzLnNjb3JlfDA7XG4gIH0sXG59KTtcblxuXG5waGluYS5tYWluKGZ1bmN0aW9uKCkge1xuXG4gIHZhciBhcHAgPSBHYW1lQXBwKHtcbiAgICB0aXRsZTogJ3BoaW5hcHB5IGJpcmQnLFxuICAgIHdpZHRoOiBTQ1JFRU5fV0lEVEgsXG4gICAgaGVpZ2h0OiBTQ1JFRU5fSEVJR0hULFxuICAgIGFzc2V0czogQVNTRVRTLFxuICAgIHN0YXJ0TGFiZWw6IGxvY2F0aW9uLnNlYXJjaC5zdWJzdHIoMSkudG9PYmplY3QoKS5zY2VuZSB8fCAnbWFpbicsXG4gICAgc3RhcnRMYWJlbDogJ21haW4nLFxuICB9KTtcblxuICAvLyBhcHAuZW5hYmxlU3RhdHMoKTtcblxuICBhcHAucnVuKCk7XG4gIFxufSk7XG5cblxuIl19
